using EvilEye.Events;
using System;
using System.Collections;
using System.Collections.Generic;
using MelonLoader;
using UnhollowerBaseLib;
using UnityEngine;
using VRC.Networking;
using EvilEye.SDK;
using VRC.SDKBase;

namespace EvilEye.Module.Exploit
{
    class UdonSpam : BaseModule
    {
        public UdonSpam() : base("Udon Spammer", "Spams Every Udon Object In The World", Main.Instance.exploitRpcGroup, null, true)
        {
        }
        public override void OnEnable()
        {
            MelonCoroutines.Start(this.UdonKill());
        }

        IEnumerator UdonKill()
        { 
            while (this.toggled)
            {
                for(int i = 0; i < PlayerWrapper.GetAllPlayers().Length; i++)
                {
                    if (PlayerWrapper.GetAllPlayers()[i].GetAPIUser().id == PlayerWrapper.LocalPlayer().GetAPIUser().id)
                        continue;

                    for (int j = 0; j < WorldWrapper.udonBehaviours.Length; j++)
                    {
                        foreach (string name in WorldWrapper.udonBehaviours[j]._eventTable.Keys)
                        {
                            Networking.SetOwner(PlayerWrapper.GetAllPlayers()[i].GetVRCPlayerApi(), WorldWrapper.udonBehaviours[j].gameObject);
                            WorldWrapper.udonBehaviours[j].SendCustomNetworkEvent(VRC.Udon.Common.Interfaces.NetworkEventTarget.Owner, name);
                            yield return new WaitForSeconds(0.25f);
                        }
                        yield return new WaitForSeconds(0.25f);
                        if (!this.toggled)
                            break;
                    }
                    yield return new WaitForSeconds(0.25f);
                    if (!this.toggled)
                        break;
                }
                
                yield return new WaitForSeconds(0.25f);
            }
            yield break;
        } 
    }
}
